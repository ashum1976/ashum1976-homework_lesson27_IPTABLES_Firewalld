#  Фильтрация пакетов. Iptables, Firewalld
## Домашнее задание по теме "Фильтрация пакетов. Iptables, Firewalld"
Задание:
- реализовать knocking port
  centralRouter может попасть на ssh inetrRouter через knock скрипт пример в материалах
- добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост
- запустить nginx на centralServer
- пробросить 8080 порт на centralServer, на inetRouter2 80
- дефолт в инет оставить через inetRouter
- реализовать проход на 8080 порт без маскарадинга

Решение:

Есть 4 VM
1. inetRouter:
  - eth0 - шлюз для выхода в Интренет приватной сети 192.168.255.0/29, поднят как NAT на вагранте. Так же для подключения по ssh с хостовой машины  
  - eth1 - 192.168.255.2/29 приватная сеть
2. centralRouter:
  - eth0 - интерфейс вагранта для управления с хостовой машины.
  - eth1 - 192.168.255.3/29 приватная сеть
  - eth2 - 192.168.0.1/28 приватная сеть 2 (192.168.0.0/28), для подключения centralServer. Запуск на centralServer-е nginx-a и доступ к нему из других сетей/хостов
3. centralServer:
  - eth0 - интерфейс вагранта для управления с хостовой машины.
  - eth1 - 192.168.0.2/28 приватная сеть 2.
4. inetRouter2:
  - eth0 - интерфейс вагранта для управления с хостовой машины.
  - eth1 - 192.168.255.4/29 приватная сеть
  - eth2 - 192.168.255.10/29 приватная сеть 3 (192.168.255.8/29) организована на virtualbox-e по типу host-only, т.е сеть доступна с хостовой машины, на которой поднимается интрфейс из этой сети с адресом 192.168.255.9/29

Организовывать работу файрвола, для проброса потов и выхода в интернет машин из приватных сетей, будем с помощью iptables.
Для проброса 8080 порта с centralServer на inetRouter2 80, применим правило для iptables:

      iptables -A PREROUTING -t nat -m tcp -p tcp --dport 80 -j DNAT --to-destination 192.168.0.2:8080

Для организации доступа к проброшенному порту centralServer:8080 -> inetRouter2:80, можно использовать правило MASQARADE на  inetRouter2:

      iptables -t nat -A POSTROUTING --source 192.168.255.8/29 -o eth1 -j MASQUERADE    <----- MASQUERADE работает только для входящих адресов из (приватная сеть 3 - 192.168.255.8/29), т.е локально с хост системы


или прописать дополнительный route на centralRouter:

      ip r a 192.168.255.8/29 via 192.168.255.4

       разрешающий прхождение пакетов из приватной сети 192.168.255.8/29

[Правила Iptables на inetRouter2](./ansible/roles/gw_iptables/files/inetRouter2_iptables)


**Реализация порт knocking**

      [Скрипт для порт knocking ](./ansible/roles/gw_iptables/files/knock_ssh.sh)

Создадим правила для iptables, на inetrRouter, что реализовать порт-knocking:

      [Правила Iptables на inetRouter2](./ansible/roles/gw/files/inetRouter_iptables)
      В правилах оставлена возможность войти с хост-системы (10.0.2.2) на машину.

Для проверки работоспособности, предварительно попробовать зайти с centralRoter  ssh -o StrictHostKeyChecking=no vagrant@192.168.255.2, при неудаче, необходимо запустить скрипт, с параметрами:

      ./knock_ssh.sh 192.168.255.2 8088 7077 9099

и с виртуальной машины centralRoter пробуем зайти ещё раз:

      ssh -o StrictHostKeyChecking=no vagrant@192.168.255.2



#   Общая теория, примеры, полезности.


- **Netfilter — межсетевой экран управляется утилитой iptables (Для IPv6 — ip6tables).**  


![Структура прохождения пакета по netfilter уточнённый вариант](https://stuffphilwrites.com/wp-content/uploads/2014/09/FW-IDS-iptables-Flowchart-v2019-04-30-1.png)

[Структура прохождения пакета по netfilter](Images/IPTables_process_flow.png)


![Альтернативное видение структуры работы IPTABLES](Images/Netfilter-tables.jpg "Альтернативное видение структуры работы IPTABLES")


[Прохождение пакета по netfilter2](https://interface31.ru/tech_it/2020/02/osnovy-iptables-dlya-nachinayushhih-chast-1.html)

![Структура прохождения пакета по таблицам](Images/IPTables_process_flow2.png)


[Интересная статья о защите от DDoS](https://javapipe.com/blog/iptables-ddos-protection/)


### Параметры конфигурации iptables

_При перезагрузке iptables разрываются все соединения, поскольку выгружаются модули iptables, сисетмы RHEL/Fedora/Oracle Linux. Для предотвращения этого, установить данный параметр в "no" :_

  - IPTABLES_MODULES_UNLOAD = "no"




###   Управление правилами сетевой фильтрации Netfilter (использование команды iptables)

Утилита iptables является интерфейсом для управления сетевым экраном netfilter. Данная команда позволяет редактировать правила таблиц, таблицы и цепочки. Как я уже говорил - каждое правило представляет собой запись/строку, содержащую в себе критерии отбора сетевых пакетов и действие над пакетами, которые соответствуют заданному правилу. Команда iptables требует для своей работы прав root.

В общем случае формат команды следующий:

- **iptables [-t таблица] команда [критерии] [действие]**


Таблица 1.    Команды и параметры утилиты iptables


<table>

  <tr>
    <th>Параметр</th>
    <th>Описание</th>
    <th>Пример</th>
  </tr>
  <tr>
      <th></th>
      <th>КОМАНДЫ</th>
      <th></th>
  </tr>
  <tr>
      <td>--append (-A)</td>
      <td>Добавить в указанную цепочку и указанную таблицу заданное правило в КОНЕЦ списка.</td>
      <td>ptables -A FORWARD критерии -j действие</td>
  </tr>
  <tr>
      <td>--delete (-D)</td>
      <td>Удаляет заданное номером(ами) или правилом(ами) правило(а). Первый пример удаляет все правила с номерами 10,12 во всех цепочках, в таблицах filter, второй пример удаляет заданное правило из таблицы mangle в цепочке PREROUTING.</td>
      <td>iptables -D 10,12
iptables -t mangle -D PREROUTING критерии -j действие</td>
  </tr>
  <tr>
      <td>--rename-chain (-E)</td>
      <td>Изменить имя цепочки.</td>
      <td>iptables -E OLD_CHAIN NEW_CHAIN</td>
  </tr>
  <tr>
      <td>--flush (-F)</td>
      <td>Очистка всех правил текущей таблицы. Ко всем пакетам, которые относятся к уже установленным соединениям, применяем терминальное действие ACCEPT — пропустить</td>
      <td>iptables -F</td>
  </tr>
  <tr>
      <td>--insert (-I)</td>
      <td>Вставляет заданное правило в место, заданное номером.</td>
      <td>iptables -I FORWARD 5 критерии -j действие</td>
  </tr>
  <tr>
      <td>--list (-L)</td>
      <td>Просмотр существующих правил (без явного указания таблицы - отображается таблица filter всех цепочек).</td>
      <td>iptables -L</td>
  </tr>
  <tr>
      <td>--policy (-P)</td>
      <td>Устанавливает стандартную(по умолчанию) политику для заданной цепочки.</td>
      <td>iptables -t mangle -P PREROUTING DROP</td>
  </tr>

<tr>
      <td>--replace (-R)</td>
      <td>Заменяет заданное номером правило на заданное в критериях.</td>
      <td>iptables -R POSROUTING 7 | критерии -j действие</td>
  </tr>
  <tr>
      <td>--delete-chain (-X)</td>
      <td>Удалить ВСЕ созданные вручную цепочки (оставить только стандартные INPUT, OUTPUT, FORWARD, PREROUTING и POSTROUTING).</td>
      <td>iptables -X</td>
  </tr>
  <tr>
      <td>--zero (-Z)</td>
      <td>Обнуляет счетчики переданных данных в цепочке.</td>
      <td>iptables -Z INPUT</td>
  </tr>
  <tr>
      <th></th>
      <th>ПАРАМЕТРЫ</th>
      <th></th>
  </tr>
  <tr>
      <td>--numeric (-n)</td>
      <td>Не резолвит адреса и протоколы при выводе.</td>
      <td></td>
  </tr>
  <tr>
      <td>--line-numbers</td>
      <td>Указывать номера правил при выводе (может использоваться совместно с -L).</td>
      <td>iptables -L --line-numbers</td>
  </tr>
  <tr>
      <td>-t таблица</td>
      <td>Задает название таблицы, над которой необходимо совершить действие. В примере сбрасываются все цепочки в  таблице nat.</td>
      <td>iptables -t nat -F</td>
  </tr>
  </table>


###   Критерии (параметры) отбора сетевых пакетов команды iptables



Критерии отбора сетевых пакетов негласно делятся на несколько групп:

- Общие критерии
- Неявные критерии
- Явные критерии

 **Общие критерии** допустимо употреблять в любых правилах, они не зависят от типа протокола и не требуют подгрузки модулей расширения. **Неявные критерии**,  т.е. критерии, которые подгружаются неявно и   становятся доступны, например при указании общего критерия --protocol tcp|udp|icmp. Перед использованием **Явных критериев**, необходимо подключить дополнительное расширение (это своеобразные  плагины для netfilter). **Дополнительные расширения подгружаются с помощью параметра -m или --match**. Так, например, если мы собираемся использовать критерии conntrack, то мы должны явно указать это в   строке правила: -m conntrack левее используемого критерия. Отличие между явными и неявными необщими критериями заключается в том, что явные нужно подгружать явно, а неявные подгружаются автоматически. Во всех критериях можно использовать знак ! перед значением критерия. Это будет означать, что под данное правило подпадают все пакеты, которые не соответствуют данному параметру.

      **! --protocol tcp** - такая запусь будет обозначать, что все пакеты, которые не являются TCP-протоколом подходят под действие правила

<table>

  <tr>
    <th>Параметр</th>
    <th>Описание</th>
    <th>Пример</th>
  </tr>
  <tr>
      <td></td>
      <td>Общие параметры</td>
      <td></td>
  <tr>
  <tr>
      <td>--protocol (-p)</td>
      <td>Определяет протокол транспортного уровня. Опции tcp, udp, icmp, all или любой другой протокол определенный в /etc/protocols</td>
      <td>iptables -A INPUT -p tcp</td>
  <tr>
  <tr>
      <td>--source(-s, --src)</td>
      <td>P адрес источника пакета. Может быть определен несколькими путями:
Одиночный хост: host.domain.tld, или IP адрес: 10.10.10.3
Пул-адресов (подсеть): 10.10.10.3/24 или 10.10.10.3/255.255.255.0
Настойчиво не рекомендуется использовать доменные имена, для разрешения (резольва) которых требуются DNS-запросы, так как на этапе конфигурирования netfilter DNS может работать некорректно. Также, заметим, имена резольвятся всего один раз — при добавлении правила в цепочку. Впоследствии соответствующий этому имени IP-адрес может измениться, но на уже записанные правила это никак не повлияет (в них останется старый адрес). Если указать доменное имя, которое резольвится в несколько IP-адресов, то для каждого адреса будет добавлено отдельное правило.</td>
      <td>iptables -A INPUT -s 10.10.10.3</td>
  <tr>
  <tr>
      <td>--destination(-d)</td>
      <td>IP адрес назначения пакета. Может быть определен несколькими путями (см. --source).</td>
      <td>iptables -A INPUT --destination 192.168.1.0/24</td>
  <tr>
  <tr>
      <td>--in-interface(-i)</td>
      <td>Определяет интерфейс, на который прибыл пакет. Полезно для NAT и машин с несколькими сетевыми интерфейсами. Применяется в цепочках INPUT, FORWARD и PREROUTING. Возможно использование знака "+", тогда подразумевается использование всех интерфейсов, начинающихся на имя+ (например eth+ - все интерфейсы eth).</td>
      <td>iptables -t nat -A PREROUTING --in-interface eth0</td>
  <tr>
  <tr>
      <td>--out-interface(-o)</td>
      <td>Определяет интерфейс, с которого уйдет пакет. Полезно для NAT и машин с несколькими сетевыми интерфейсами. Применяется в цепочках OUTPUT, FORWARD и POSTROUTING. Возможно использование знака "+".</td>
      <td>iptables -t nat -A POSTROUTING --in-interface eth1</td>
  <tr>
  <tr>
      <td></td>
      <td>Неявные (необщие) параметры</td>
      <td></td>
  <tr><tr>
      <td>-p proto -h</td>
      <td>вывод справки по неявным параметрам протокола proto.</td>
      <td>iptables -p icmp -h</td>
  <tr>
  <tr>
      <td>--source-port(--sport)</td>
      <td>Порт источник, возможно только для протоколов --protocol tcp, или --protocol udp</td>
      <td>iptables -A INPUT --protocol tcp --source-port 25</td>
  <tr>
  <tr>
      <td>--destination-port(--dport)</td>
      <td>Порт назначения, возможно только для протоколов --protocol tcp, или --protocol udp</td>
      <td>iptables -A INPUT --protocol udp --destination-port 67</td>
  <tr>
  <tr>
      <td></td>
      <td>Явные параметры</td>
      <td></td>
  <tr>
  <tr>
      <td>-m conntrack --ctstate</td>
      <td>Состояние соединения. Доступные опции:  
NEW (Все пакеты устанавливающие новое соединение)
ESTABLISHED (Все пакеты, принадлежащие установленному соединению)
RELATED (Пакеты, не принадлежащие установленному соединению, но связанные с ним. Например - FTP в активном режиме использует разные соединения для передачи данных. Эти соединения связаны.)
INVALID (Пакеты, которые не могут быть по тем или иным причинам идентифицированы. Например, ICMP ошибки не принадлежащие существующим соединениям)
и др.</td>
      <td>iptables -A INPUT -m conntrack --ctstate NEW,ESTABLISHED</td>
  <tr>
  <tr>
      <td>-m mac --mac-source</td>
      <td>Задает MAC адрес сетевого узла, передавшего пакет. MAC адрес должен указываться в форме XX:XX:XX:XX:XX:XX.</td>
      <td>-m mac --mac-source 24:12:B0:A4:F6:03 Действия над пакетами</td>
  <tr>

</table>

- **_CONNTRACK_**

Модуль(критерий) conntrack позволяет реализовать межсетевой экран сеансового уровня (пятого уровня модели OSI). Для управления данным механизмом используется утилита **conntrack**, а так же параметр утилиты **iptables: -m conntrack или -m state (устарел)** Состояния текущих соединений conntrack хранит в ядре. Их можно просмотреть в файле **_/proc/net/nf_conntrack_** (или **_/proc/net/ip_conntrack_**) Conntrack анализирует состояние всех пакетов, кроме тех, которые помечены как NOTRACK в таблице raw. На основе этого состояния определяется принадлежит пакет новому соединению (состояние NEW), уже установленному соединению (состояние ESTABLISHED), дополнительному к уже существующему (RELATED), либо к "другому" (неопределяемому) соединению (состояние INVALID).

- **_TIME_**

Модуль(критерий) time
  - **--timestart time** - соответствие началу  в пределах 00:00:00 and 23:59:59
  - **--timestop time** - соответствие окончанию в пределах 00:00:00 and 23:59:59
  - **--datestart time** - соответствие дате начала (YYYY[-MM[-DD[Thh[:mm[:ss]]]]])
  - **--datestop time** - соответствие дате окончания (YYYY[-MM[-DD[Thh[:mm[:ss]]]]])
  - **--[!]monthdays value** - соответствие или не соответствие дням месяца, от 1 до 31
  - **--[!]weekdays value** - соответствие или не соответствие дням недели от 1 до 7 или Mon,Tue,Wed,Thu,Fri,Sat,Sun
  - **--kerneltz** - параметр предписывающий работать с kernel timezone, вместо UTC




####  Действия над пакетами, которые совпали с критериями отбора

Для совершения какого-либо действия над пакетами, необходимо задать ключ **_-j (--jump)_** и указать, какое конкретно действие совершить.

- **ACCEPT** - пакет покидает данную цепочку и передается в следующую (дословно - ПРИНЯТЬ).
- **DROP** - отбросить удовлетворяющий условию пакет, при этом пакет не передается в другие таблицы/цепочки.
- **REJECT** - отбросить пакет, отправив отправителю ICMP-сообщение, при этом пакет не передается в другие таблицы/цепочки.
- **RETURN** - возвратить пакет в предыдущую цепочку и продолжить ее прохождение начиная со следующего правила.
- **SNAT** - применить трансляцию адреса источника в пакете. Может использоваться только в цепочках POSTROUTING и OUTPUT в таблицах nat.
- **DNAT** - применить трансляцию адреса назначения в пакете. Может использоваться в цепочке PREROUTING в таблице nat. (в исключительных случаях - в цепочке OUTPUT)
- **LOG** - протоколировать пакет (отправляется демону syslog) и обработать остальными правилами.
- **MASQUERADE** — используется вместо SNAT при наличии соединения с динамическим IP (допускается указывать только в цепочке POSTROUTING таблицы nat).
- **MARK** — используется для установки меток на пакеты, передается для обработки дальнейшим правилам.
- **DELUDE** - создать видимость открытого TCP-порта. На SYN-пакеты отвечает пакетами SYN/ACK, на все прочие пакеты отвечает RST. Очень полезно для введения в заблуждение злоумышленника, сканирующего порты вашего хоста.

- _**TRACE**_ - Трассировка прохождения пакета по цепочкам. Включается в таблице raw. Должен писать вывод в файл /var/log/messages, если включить эту возможность в rsyslog.conf (строка: kern.* ..... /var/log/message).
  - **iptables -I PREROUTING 1 -t raw -p udp  -j TRACE** - пример трассировки udp пакета
  - **xtables-monitor -t** - утилита для просмотра трассировки пакета

- _**REDIRECT:**_

     **Действие REDIRECT предназначено для перенаправления пакетов с одного набора портов на другой внутри одной системы, не выходя за пределы хоста.**

     Работает REDIRECT только в цепочках PREROUTING и OUTPUT таблицы nat. Таким образом, область применения сводится только к перенаправлению с одного порта на другой. Чаще всего это используется для прозрачного прокси, когда клиент из локальной сети коннектится на 80 порт, а шлюз редиректит пакеты на локальный порт прокси:

     iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3128

  - _REDIRECT и удаленный клиент:_

     правило будет работать только для внешних клиентов и только при открытом порте приложения.

     iptables -t nat -A PREROUTING -p tcp --dport 5555 -j REDIRECT --to-port 22

   - _REDIRECT и локальный клиент:_

     предыдущее правило для самого хоста с iptables не сработает, т.к. пакеты с localhost не попадают в таблицу nat. Чтобы кейс сработал на локальной машине — надо добавить редирект в цепочку OUTPUT таблицы nat:

     iptables -t nat -A OUTPUT -p tcp -s 127.0.0.1 --dport 5555 -j REDIRECT --to-ports 22

- **TARPIT** — «подвесить» TCP-соединение. Используется лишь в самых крайних случаях, например, при борьбе с DoS-атаками. Отвечает на входящее соединение, после чего уменьшает размер фрейма до нуля, блокируя возможность передачи данных. Соединение будет «висеть» в таком состоянии пока не истечет тайм-аут на атакующей стороне (обычно 20—30 минут). При этом на такое соединение расходуются системные ресурсы атакующей стороны (процессорное время и оперативная память), что может быть весьма ощутимо при значительном количестве соединений. В случае правильного использования действия TARPIT ресурсы атакуемой стороны практически не расходуются.
Под правильным применением понимается предотвращение обработки таких соединений подсистемой conntrack, так как в противном случае будут расходоваться системные ресурсы самого атакуемого хоста. Например, перед добавлением правила блокирования порта

      iptables -I INPUT -p tcp --dport 25 -j TARPIT

      обязательно добавляйте в таблицу raw соответствующее правило:

      iptables -t raw -I PREROUTING -p tcp --dport 25 -j NOTRACK

___

#### Фдаги tcp пакета

- **--tcp-flags:**

      URG - срочное сообщение;
      ACK - квитанция на принятый сегмент;
      PSH - запрос на отправку сообщения без ожидания заполнения буфера;
      RST - запрос на восстановление соединения;
      SYN - сообщение используемое для синхронизации счетчиков переданных данных при установлении соединения;
      FIN - признак достижения передающей стороной последнего байта в потоке передаваемых данных.


      Флаги: _**SYN ACK FIN RST URG PSH ALL NONE**_
      Совпадение, когда флаги TCP указаны правильно. Первый аргумент mask-это флаги, которые мы должны изучить, записанные в виде списка, разделенного запятыми, а второй аргумент - это разделенный запятыми список флагов, которые должны быть установлены. Отсюда и команда: _**iptables -A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST SYN**_ будет соответствовать только пакетам с установленным флагом SYN , а флаги ACK, FIN and RST не установлены. Это соответствует новому соединению "--syn"

# ipset

Представляет собой набор инструментов, позволяющий работать с большими списками (sets) IP-адресов и/или портов. Поддерживается возможность динамического обновления списков при прохождении пакетов через правила netfilter.

ipset состоит из следующих элементов:

- Модуль ядра ip_set, обеспечивающий базовый инструментарий работы со списками записей, который используется модулями расширений.
- Модули расширений, определяющие конкретные структуры записей и методы работы с ними, например, ip_set_hash_ip (тип данных hash: ip), ip_set_bitmap_port (тип данных bitmap: port) и т. д.
- Userspace-утилита ipset, позволяющая выполнять различные операции со списками и записями в них:
      Создание, удаление, переименование, вывод, очистка списков.
      Добавление и удаление записей из списков, проверка наличия записи в списке.
      Вывод справочной информации по работе со списками различного типа.

- Модули расширений для утилиты ipset, соответствующие модулям расширений в ядре, например, ipset_hash_ip (тип данных hash: ip), ipset_bitmap_port (тип данных bitmap: port) и т. д. Каждый такой модуль отвечает за обеспечение интерфейса между «своим» модулем ядра и конечным пользователем, в частности, проверку корректности вводимых и форматирование выводимых данных, а также вывод справочной информации по допустимым командам и параметрам. В ранних версиях ipset (до 4 включительно) такие модули выделялись в виде подгружаемых библиотек, однако в современных версиях ipset они статически включаются в основной бинарник, поэтому разделение существует лишь в исходном коде.
- Модуль netfilter xt_set (критерий set и действие SET), а также соответствующие модули (библиотеки) iptables (libxt_set и libxt_SET). Критерий set позволяет проверять различные параметры пакета (IP/MAC-адреса, TCP/UDP-порты источника и/или получателя) на предмет нахождения или отсутствия в списке. Действие SET позволяет добавлять или удалять записи из списка на основании указанных параметров пакета.


ipset поддерживает следующие типы данных:

- bitmap: ip (ipmap) — полный перечень IP-адресов. Ключ **range <IP start>-<IP end>**. Диапазон конечно же должен быть линейный.
- bitmap: ip, mac (macipmap) — полный перечень IP-адресов, причем вместе с каждым IP-адресом может быть сохранен MAC-адрес.
- bitmap: port (portmap) — полный перечень портов. Задаётся ключом **range 0-1024**, и потом добавлять нужные порты в список, принадлежащие этому диапазону
- hash: ip (iphash) — выборочный перечень IP-адресов (либо IP-подсетей с одинаковой маской).
- hash: net (nethash) — выборочный перечень IP-подсетей (блоков IP-адресов). В отличие от hash: ip, в одном списке могут присутствовать подсети с различными масками.
- hash: ip, port (ipporthash) — выборочный перечень IP-адресов, причем с каждым адресом может быть сохранен порт.  Начиная с версии ipset 5, для каждого номера порта можно также сохранять идентификатор протокола транспортного уровня.
- hash: ip, port, ip (ipportiphash) — выборочный перечень IP-адресов, причем с каждым адресом может быть сохранен порт и еще один IP-адрес.  Начиная с версии ipset 5, для каждого номера порта можно также сохранять идентификатор протокола транспортного уровня.
- hash: ip, port, net (ipportnethash) — выборочный перечень IP-адресов, причем с каждым адресом может быть сохранен порт и IP-подсеть. Начиная с версии ipset 5, для каждого номера порта можно также сохранять идентификатор протокола транспортного уровня.
- list: set (setlist) — список списков. Может содержать списки любого перечисленного здесь типа, кроме list: set. При обращении к такому объекту из netfilter, включенные в него списки рассматриваются как один большой список. Поиск записей (критерий set) производится по всем вложенным спискам соответствующего типа. При добавлении записей (действие SET), вложенные списки поочередно проверяются (согласно порядку их перечисления) на соответствие типа и наличие свободного места, и запись добавляется в первый же подходящий. В то же время, при обращении к такому списку через утилиту ipset, он рассматривается именно как совокупность элементов-списков, что позволяет добавлять, удалять и проверять наличие именно вложенных списков, но не их элементов.
- hash: net, iface — выборочный перечень IP-подсетей, причем с каждой подсетью может быть сохранено название сетевого интерфейса. Существует ограничение: нельзя сохранять более 64 имен интерфейсов с одним и тем же адресом подсети. Этот тип данных удобен при наличии в системе большого количества сетевых интерфейсов (например, сотен VLAN-интерфейсов).

Большинство перечисленных типов данных можно разделить на две группы: **полные перечни (map, bitmap)** и **выборочные перечни (hash, tree)**. Разница между этими типами состоит в следующем: если выборочный перечень **сохраняет только те элементы, которые в него входят,** то полный перечень представляет собой **таблицу логических значений (битов) для всех элементов,** которые могут входить в данный перечень, и вхождение конкретного элемента в перечень определяется значением соответствующего бита. **Полный перечень всегда формируется на базе одного непрерывного диапазона значений**.

      ipset create foo bitmap:ip,mac range 192.168.0.0/16 <--- range - обязательный параметр, для полного перечня

##

- Основные команды
  - **n, create**
  - **-A, add**
  - **-L, list**
  - **-X, destroy**
  - **del**
  - **-T, test**
  - **-S, save**
  - **restore**
- Вспомогательные команды

### Опции создания сета и добавления значений

- timeout
- counters, packets, bytes
- skbinfo
  - skbmark
  - skbprio
  - skbqueue
- hashsize
- maxelem
- family
- nomatch
- forceadd



## Полезные правила для iptables
##### Анти DDos 1
- Пакеты в статусе INVALID:

      iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP

- Стандартно новые пакеты, которые таковыми не являются:

      iptables -t mangle -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP


- Блокировать необычные значения MSS:

      iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP

##### Анти DDos 2

- Защита от сканирования портов. Будем банить на 10 минут всех, кто обратится не на открытые порты, например, 5060 и 22.

      iptables -A INPUT -m recent --rcheck --seconds 600 --name BANLIST -j DROP
      iptables -A INPUT -p tcp -m multiport ! --dports 22,5060 -m recent --set --name BANLIST -j DROP
      iptables -A INPUT -p tcp --syn --dport 22 -j ACCEPT
      iptables -A INPUT -p tcp --syn --dport 5060 -j ACCEPT

- Защита от bruteforce средствами iptables на примере ssh порта:

      iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name BANLIST --set
      iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name BANLIST --update --seconds 60 --rttl --hitcount 3 -j DROP
      iptables -A INPUT -p tcp --syn --dport 22 -j ACCEPT

      Разрешаем только 3 запроса в минуту, третий должен быть удачным, чтобы подключиться, иначе ip адрес уходит в бан на 60 секунд.

      Можно то же самое сделать с помощью модуля hashlimit. С одного ip разрешаем 2 запроса на соединение (NEW) в минуту (2/m) все остальные пакеты (NEW) c этого ip блокируется:

      iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m hashlimit --hashlimit-name BANLIST --hashlimit-mode srcip --hashlimit-above 2/m --hashlimit-burst 2 -j DROP
      iptables -A INPUT -p tcp --syn --dport 22 -j ACCEPT

      Посмотреть содержимое создаваемого списка BANLIST можно так:

      cat /proc/net/xt_recent/BANLIST

          src=192.168.13.15 ttl: 128 last_seen: 4295998682 oldest_pkt: 1 4295998682
          src=10.8.0.2 ttl: 127 last_seen: 4296007032 oldest_pkt: 4 4295389944, 4295734397, 4295895199, 4296007032
